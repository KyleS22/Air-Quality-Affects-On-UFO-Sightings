<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Air Quality and U.F.O. Sightings </title>
    <script type="text/javascript" src="d3.v5.min.js"></script>

    <style>

        html,body {
            margin:0px;
        }

        svg {
            display: block;
            margin: 25px auto;
        }
        
        line {
            stroke: #ccc;
            stroke-width: 1;
        }

        .panel {
            float:left;
        }

        #right-panel{
            text-align: center;
            vertical-align: top;
            box-sizing: border-box;
            padding: 50px;
        }

        /* style for slider */
        .slidecontainer {
            width: 100%;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 15px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        
        .slider-heading {
            font-family: sans-serif; 
            margin-top:40px;
        }

    </style>

</head>

<body>
    <div id='left-panel' class='panel'><svg id="map_vis"></svg></div>
    <div id='right-panel' class='panel'>
        <h3 class='slider-heading'>Force Strength : <span id='force-value'>0.5</span></h3>
        <div class="slidecontainer">
            <input type="range" min="0" max="1" value="0.5" step='any' class="slider" id="slider-input">
        </div>
    </div>
</body>

<script type="text/javascript">
    //Width and height
    var w = 800;
    var h = 400;

    var bodyWidth = +d3.select("body").node().getBoundingClientRect().width;
    var rightPanelWidth = bodyWidth - (w);

    // For very small screens the control panel width would be very small and so we cap it at 500 pixels
    d3.select('#right-panel').style('width', Math.max(rightPanelWidth, 500) + "px");

    

    //Define quantize scale to sort data values into buckets of color
    var color = d3.scaleQuantize()
        .range(["rgb(237,248,233)", "rgb(186,228,179)", "rgb(116,196,118)", "rgb(49,163,84)", "rgb(0,109,44)"]);

    //Number formatting for population values
    var formatAsThousands = d3.format(","); //e.g. converts 123456 to "123,456"

    // Dictionary keyed by year_month, or year_all, each element is a dictionary keyed by city
    var year_city_dict = {}

    //Load in U.F.O. data
    d3.csv("UFOPOLLUTANTS.csv").then(function(data) {
        //Set input domain for color scale
        color.domain([
            d3.min(data, function(d) {
                return d.value;
            }),
            d3.max(data, function(d) {
                return d.value;
            })
        ]);

        //Load in GeoJSON data
        d3.json("us-states.json").then(function(states_json) {

        
            //Load in cities data and combine with U.F.O counts (probably its own dictionary?)
            d3.csv("all_us_cities.csv").then(function(cities_data) {
                
                // Cache for the city locations when we get them so we don't have to find the lat and long every time we read a new data row
                city_locations = {}

                //Merge the pollutant data and GeoJSON
                //Loop through once for each pollutant data value
                for (var i = 0; i < data.length; i++) {
                // TODO: Compute histograms of U.F.O. count for each state by year (and month?) and store in a dict of state_hists
                // TODO: Compute histograms of U.F.O. count for each month by year and store in a dict of month_hists
                // TODO: Compute breakdowns of pollutant AQI for each city by year as well as times of U.F.O sightings and store in a dict of city_pollutants
                // TODO: Stuff the data below into an object we can use to create the whole map at once later on
                // Also put pollutant breakdowns somewhere in the map data for the pie markers
                
                    // Get the relevant data from the current row
                    data_row = data[i];

                    data_city = data_row["city"];
                    data_state = data_row["state"];
                    data_day = parseInt(data_row["day"]);
                    data_month = parseInt(data_row["month"]);
                    data_year = parseInt(data_row["year"]);
                    data_NO2_AQI = parseFloat(data_row["NO2.AQI"]);
                    data_O3_AQI = parseFloat(data_row["O3.AQI"]);
                    data_SO2_AQI = parseFloat(data_row["SO2.AQI"]);
                    data_CO_AQI = parseFloat(data_row["CO.AQI"]);
                    data_UFO_SIGHTING = parseInt(data_row["ET"]);
                    
                    
                    // Get the location of the city
                    var lat;
                    var long;

                    if(data_city in city_locations){
                        lat = city_locations[data_city].lat;
                        long = city_locations[data_city].long;
                    }else{
                        for(var j = 0; j < cities_data.length; j++){
                            city = cities_data[j];

                            if(city.City.toLowerCase() == data_city.toLowerCase()){
                                city_locations[data_city] = {
                                    lat: city.Latitude,
                                    long: city.Longitude
                                };

                                lat = city.Latitude;
                                long = city.Longitude;
                                break;
                            }
                        }
                    }
                    
                    // Get the city data collected for this year and month combo
                    var city_breakdown = {};
                    var city_breakdown_all = {};

                    var year_month_key = data_year + "_" + data_month;
                    var year_all_key = data_year + "_all";

                    if(year_month_key in year_city_dict){
                        city_breakdown = year_city_dict[year_month_key];
                    }

                    if(year_all_key in year_city_dict){
                        city_breakdown_all = year_city_dict[year_all_key];
                    }


                    // Get the current cities data so we can update it

                    if(data_city in city_breakdown){
                        current_city_data = city_breakdown[data_city];
                        current_city_data.num_sightings += data_UFO_SIGHTING;
                        current_city_data.pollutant_breakdown.push({
                            NO2: data_NO2_AQI,
                                O3: data_O3_AQI,
                                SO2: data_SO2_AQI,
                                CO: data_CO_AQI,
                                day: data_day,
                                sighting: data_UFO_SIGHTING
                            });
                            
                        city_breakdown[data_city] = current_city_data;

                    }else{
                        current_city_data = {
                            num_sightings: data_UFO_SIGHTING,
                            pollutant_breakdown: [{
                                NO2: data_NO2_AQI,
                                O3: data_O3_AQI,
                                SO2: data_SO2_AQI,
                                CO: data_CO_AQI,
                                day: data_day,
                                sighting: data_UFO_SIGHTING
                            }],
                            lat: lat,
                            long: long,
                        }

                        city_breakdown[data_city] = current_city_data;
                    }

                    if(data_city in city_breakdown_all){
                        current_city_data = city_breakdown[data_city];
                        current_city_data.num_sightings += data_UFO_SIGHTING;
                        current_city_data.pollutant_breakdown.push({
                            NO2: data_NO2_AQI,
                                O3: data_O3_AQI,
                                SO2: data_SO2_AQI,
                                CO: data_CO_AQI,
                                day: data_day,
                                sighting: data_UFO_SIGHTING
                            });

                        city_breakdown_all[data_city] = current_city_data;

                    }else{
                        current_city_data = {
                            num_sightings: data_UFO_SIGHTING,
                            pollutant_breakdown: [{
                                NO2: data_NO2_AQI,
                                O3: data_O3_AQI,
                                SO2: data_SO2_AQI,
                                CO: data_CO_AQI,
                                day: data_day,
                                sighting: data_UFO_SIGHTING
                            }],
                            lat: lat,
                            long: long,
                        }

                        city_breakdown_all[data_city] = current_city_data;
                    }

                    year_city_dict[year_month_key] = city_breakdown;
                    year_city_dict[year_all_key] = city_breakdown_all;

                }
                
            });
            
            console.log(year_city_dict);

        });

    });


function draw_map(state_data, city_data) {

    //Modify SVG element
    var map_svg = d3.select("#map_vis")
        .attr("width", w)
        .attr("height", h);

    //Define map projection
    var projection = d3.geoAlbersUsa()
        .translate([w / 2, h / 2])
        .scale([500]);

    // Define path generator
    var path = d3.geoPath()
        .projection(projection);


     //Bind data and create one path per GeoJSON feature
     map_svg.selectAll("path")
        .data(state_data.features)
        .enter()
        .append("path")
        .attr("d", path);
        
        // Draw cities
        map_svg.selectAll("circle")
            .data(city_data)
            .enter()
            .append("circle")
            .attr("cx", function(d) {
                return projection([d.lon, d.lat])[0];
            })
            .attr("cy", function(d) {
                return projection([d.lon, d.lat])[1];
            })
            .attr("r", 5)
            .style("fill", "yellow");


}

function draw_pollutant_breakdown(){

}

function draw_state_hist() {

}

function draw_month_hist(){

}

</script>

</html>